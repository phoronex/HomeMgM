<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="login_title">Login - Home Purchase Manager</title>
    <link rel="stylesheet" href="/assets/css/theme.css">
    <link rel="stylesheet" href="/assets/css/layout.css">
    <link rel="stylesheet" href="/assets/css/components.css">
    <link rel="stylesheet" href="/assets/css/rtl-overrides.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="language-switcher">
            <button class="lang-btn active" data-lang="en">English</button>
            <button class="lang-btn" data-lang="ar">العربية</button>
        </div>
        
        <div class="login-card">
            <div class="login-header">
                <h1 class="logo" data-i18n="app_title">Home Purchase Manager</h1>
                <p data-i18n="login_subtitle">Manage your household purchases efficiently</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username" class="form-label" data-i18n="username">Username</label>
                    <input type="text" id="username" class="form-control" required data-i18n-placeholder="enter_username">
                </div>
                
                <div class="form-group">
                    <label for="password" class="form-label" data-i18n="password">Password</label>
                    <input type="password" id="password" class="form-control" required data-i18n-placeholder="enter_password">
                </div>
                
                <button type="submit" class="btn btn-full" data-i18n="login_btn">Login</button>
            </form>
            
            <div id="loginError" class="alert alert-error" style="display: none;"></div>
            
            <div class="login-footer">
                <p data-i18n="no_account">Don't have an account?</p>
                <a href="#" id="registerLink" data-i18n="register_now">Register Now</a>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="register_title">Create New Account</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="form-group">
                        <label for="regUsername" class="form-label" data-i18n="username">Username</label>
                        <input type="text" id="regUsername" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regEnglishName" class="form-label" data-i18n="english_name">English Name</label>
                        <input type="text" id="regEnglishName" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regArabicName" class="form-label" data-i18n="arabic_name">Arabic Name</label>
                        <input type="text" id="regArabicName" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="regEmail" class="form-label" data-i18n="email">Email</label>
                        <input type="email" id="regEmail" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regApartmentId" class="form-label" data-i18n="apartment_id">Apartment ID</label>
                        <input type="text" id="regApartmentId" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regPassword" class="form-label" data-i18n="password">Password</label>
                        <input type="password" id="regPassword" class="form-control" required>
                        <div id="passwordStrength"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="regConfirmPassword" class="form-label" data-i18n="confirm_password">Confirm Password</label>
                        <input type="password" id="regConfirmPassword" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regPreferredLanguage" class="form-label" data-i18n="preferred_language">Preferred Language</label>
                        <select id="regPreferredLanguage" class="form-control">
                            <option value="en">English</option>
                            <option value="ar">العربية</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn" data-i18n="register_btn">Register</button>
                        <button type="button" class="btn btn-secondary modal-close" data-i18n="cancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="/assets/js/firebase-config.js"></script>
    <script src="/assets/js/utils/language-manager.js"></script>
    <script src="/assets/js/utils/date-manager.js"></script>
    <script src="/assets/js/utils/password-manager.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize language manager
            await languageManager.init();
            
            // Initialize auth manager
            authManager.init();
            
            // Setup language switcher
            setupLanguageSwitcher();
            
            // Setup modal
            setupModal();
            
            // Setup forms
            setupForms();
            
            // Check if user is already logged in
            authManager.addAuthListener((user) => {
                if (user) {
                    window.location.href = 'dashboard.html';
                }
            });
        });
        
        function setupLanguageSwitcher() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const lang = btn.getAttribute('data-lang');
                    languageManager.switchLanguage(lang);
                    
                    // Update active state
                    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
            
            // Set initial active state
            document.querySelector(`.lang-btn[data-lang="${languageManager.currentLang}"]`).classList.add('active');
        }
        
        function setupModal() {
            const registerLink = document.getElementById('registerLink');
            const registerModal = document.getElementById('registerModal');
            const modalCloseBtns = document.querySelectorAll('.modal-close');
            
            registerLink.addEventListener('click', (e) => {
                e.preventDefault();
                registerModal.classList.add('active');
            });
            
            modalCloseBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal').classList.remove('active');
                });
            });
            
            // Close modal when clicking outside
            registerModal.addEventListener('click', (e) => {
                if (e.target === registerModal) {
                    registerModal.classList.remove('active');
                }
            });
        }
        
        function setupForms() {
            // Login form
            const loginForm = document.getElementById('loginForm');
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const errorDiv = document.getElementById('loginError');
                
                try {
                    const result = await authManager.login(username, password);
                    
                    if (result.success) {
                        window.location.href = 'dashboard.html';
                    } else {
                        errorDiv.textContent = result.error;
                        errorDiv.style.display = 'block';
                    }
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            });
            
            // Registration form
            const registerForm = document.getElementById('registerForm');
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const userData = {
                    userName: document.getElementById('regUsername').value,
                    englishName: document.getElementById('regEnglishName').value,
                    arabicName: document.getElementById('regArabicName').value,
                    email: document.getElementById('regEmail').value,
                    apartmentId: document.getElementById('regApartmentId').value,
                    password: document.getElementById('regPassword').value,
                    confirmPassword: document.getElementById('regConfirmPassword').value,
                    preferredLanguage: document.getElementById('regPreferredLanguage').value,
                    role: 'apartmentUser'
                };
                
                // Validate passwords match
                if (userData.password !== userData.confirmPassword) {
                    showNotification('Passwords do not match', 'error');
                    return;
                }
                
                try {
                    const result = await authManager.register(userData);
                    
                    if (result.success) {
                        showNotification('Registration successful! Please login.', 'success');
                        document.getElementById('registerModal').classList.remove('active');
                        registerForm.reset();
                    } else {
                        showNotification(result.error, 'error');
                    }
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            });
            
            // Password strength indicator
            document.getElementById('regPassword').addEventListener('input', (e) => {
                const password = e.target.value;
                const strengthContainer = document.getElementById('passwordStrength');
                
                if (!password) {
                    strengthContainer.innerHTML = '';
                    return;
                }
                
                const strength = passwordManager.checkPasswordStrength(password);
                
                let strengthClass = 'strength-weak';
                if (strength.strength === 'Medium') strengthClass = 'strength-medium';
                if (strength.strength === 'Strong') strengthClass = 'strength-strong';
                if (strength.strength === 'Very Strong') strengthClass = 'strength-very-strong';
                
                strengthContainer.innerHTML = `
                    <div class="password-strength ${strengthClass}">
                        <div class="strength-bar" style="width: ${strength.score * 10}%"></div>
                        <span>${strength.strength}</span>
                    </div>
                `;
            });
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Hide and remove after delay
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>